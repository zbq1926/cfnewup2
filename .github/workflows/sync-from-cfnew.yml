name: 从 cfnew 同步 Releases

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 */6 * * *'  # 每6小时自动检查一次

jobs:
  同步发布:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 获取 cfnew 最新发布
        id: 获取最新版本
        run: |
          # 获取最新 release 信息
          echo "正在获取最新发布信息..."
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/byJoey/cfnew/releases/latest)
          
          # 使用 sed 提取版本号（兼容性更好）
          VERSION=$(echo "$LATEST_RELEASE" | sed -n 's/.*"tag_name": "\([^"]*\)".*/\1/p')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "最新版本: $VERSION"
          
          # 获取所有 assets 文件
          ASSETS_URL=$(echo "$LATEST_RELEASE" | sed -n 's/.*"assets_url": "\([^"]*\)".*/\1/p')
          echo "正在获取文件列表..."
          ASSETS=$(curl -s "$ASSETS_URL")
          
          # 提取第一个 asset 的下载 URL 和文件名
          DOWNLOAD_URL=$(echo "$ASSETS" | sed -n 's/.*"browser_download_url": "\([^"]*\)".*/\1/p' | head -1)
          FILE_NAME=$(echo "$ASSETS" | sed -n 's/.*"name": "\([^"]*\)".*/\1/p' | head -1)
          
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "下载 URL: $DOWNLOAD_URL"
          echo "文件名: $FILE_NAME"
      
      - name: 检查当前版本
        id: 检查版本
        run: |
          # 读取当前记录的版本，如果文件不存在则创建空文件
          if [ ! -f "VERSION.txt" ]; then
            echo "未找到版本记录文件，创建新文件"
            touch VERSION.txt
            CURRENT_VERSION=""
          else
            CURRENT_VERSION=$(cat VERSION.txt | tr -d '\n\r ')
            if [ -z "$CURRENT_VERSION" ]; then
              echo "版本记录文件为空，将进行首次更新"
            else
              echo "当前记录的版本: $CURRENT_VERSION"
            fi
          fi
          
          NEW_VERSION="${{ steps.获取最新版本.outputs.version }}"
          echo "latest_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # 如果版本文件不存在或为空，或者版本不同，则需要更新
          if [ -z "$CURRENT_VERSION" ] || [ "$CURRENT_VERSION" != "$NEW_VERSION" ]; then
            if [ -z "$CURRENT_VERSION" ]; then
              echo "首次运行，将下载文件并创建版本记录"
            else
              echo "发现新版本 $CURRENT_VERSION -> $NEW_VERSION，需要更新"
            fi
            echo "need_update=true" >> $GITHUB_OUTPUT
          else
            echo "版本相同，无需更新"
            echo "need_update=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 下载并更新文件
        if: steps.检查版本.outputs.need_update == 'true'
        run: |
          DOWNLOAD_URL="${{ steps.获取最新版本.outputs.download_url }}"
          FILE_NAME="${{ steps.获取最新版本.outputs.file_name }}"
          VERSION="${{ steps.获取最新版本.outputs.version }}"
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "错误：未找到可下载的文件"
            exit 1
          fi
          
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "错误：未获取到版本号"
            exit 1
          fi
          
          echo "正在下载文件: $FILE_NAME"
          curl -L -o "$FILE_NAME" "$DOWNLOAD_URL"
          
          if [ ! -f "$FILE_NAME" ]; then
            echo "错误：下载失败"
            exit 1
          fi
          
          echo "下载成功: $FILE_NAME"
          
          # 确保创建或更新版本记录文件
          if [ ! -f "VERSION.txt" ]; then
            echo "创建版本记录文件"
            touch VERSION.txt
          fi
          
          # 写入版本号
          echo "$VERSION" > VERSION.txt
          echo "版本记录已创建/更新: $VERSION"
          
          # 验证文件是否成功写入
          if [ -f "VERSION.txt" ] && [ -s "VERSION.txt" ]; then
            echo "✓ 版本记录文件创建成功"
          else
            echo "✗ 警告：版本记录文件可能未正确创建"
          fi
      
      - name: 提交并推送更改
        if: steps.检查版本.outputs.need_update == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "没有变更需要提交"
          else
            git commit -m "自动同步: 更新到 cfnew ${{ steps.获取最新版本.outputs.version }}"
            git push
            echo "已提交并推送更新"
          fi
      
      - name: 输出摘要
        run: |
          echo "## 同步结果" >> $GITHUB_STEP_SUMMARY
          echo "- 最新版本: ${{ steps.获取最新版本.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- 当前版本: ${{ steps.检查版本.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.检查版本.outputs.need_update }}" = "true" ]; then
            echo "- 状态: ✅ 已更新到新版本" >> $GITHUB_STEP_SUMMARY
            echo "- 下载文件: ${{ steps.获取最新版本.outputs.file_name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- 状态: ⏭️ 版本相同，无需更新" >> $GITHUB_STEP_SUMMARY
          fi

